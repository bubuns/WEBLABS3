# Лабораторная работа № 5. Авторизация и агрегирование данных

Веб-приложение для управления учетными записями пользователей с системой авторизации и формированием статистических отчётов.

## Новый функционал

### Система авторизации

Реализована система проверки прав пользователей с декоратором `check_rights`:

**Права администратора:**
- Создание пользователей
- Редактирование пользователей  
- Просмотр профиля пользователя
- Удаление пользователей
- Просмотр журнала посещений (всех страниц)

**Права обычного пользователя:**
- Редактирование своих данных (кроме роли)
- Просмотр своего профиля
- Просмотр журнала посещений (только свои записи)

### Журнал посещений

- **Автоматическое логирование**: Все посещения страниц автоматически записываются в таблицу `visit_logs`
- **Модель VisitLog**: Содержит поля `id`, `path`, `user_id`, `created_at`
- **Декоратор before_request**: Автоматически создает записи о посещениях

### Статистические отчёты

Реализован модуль отчетов через Blueprint:

#### Главная страница журнала посещений (`/reports/`)
- Таблица с записями посещений
- Колонки: №, Пользователь, Страница, Дата
- Пагинация (10 записей на страницу)
- Сортировка по убыванию даты

#### Отчет по страницам (`/reports/by_pages`)
- Статистика посещения страниц
- Колонки: №, Страница, Количество посещений
- Сортировка по убыванию количества посещений
- Экспорт в CSV

#### Отчет по пользователям (`/reports/by_users`)
- Статистика посещений по пользователям
- Колонки: №, Пользователь, Количество посещений
- Сортировка по убыванию количества посещений
- Экспорт в CSV

## Структура проекта

```
├── app.py                    # Основное приложение Flask
├── reports.py                # Blueprint для модуля отчетов
├── test_app.py              # Тесты для всего функционала
├── requirements.txt         # Зависимости Python
├── templates/               # HTML шаблоны
│   ├── base.html           # Базовый шаблон
│   ├── index.html          # Главная страница
│   ├── login.html          # Страница входа
│   ├── view_user.html      # Просмотр пользователя
│   ├── user_form.html      # Форма создания/редактирования
│   ├── change_password.html # Смена пароля
│   └── reports/            # Шаблоны отчетов
│       ├── index.html      # Главная страница журнала
│       ├── by_pages.html   # Отчет по страницам
│       └── by_users.html   # Отчет по пользователям
└── users.db                # База данных SQLite
```

## Установка и запуск

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Запустите приложение:
```bash
python app.py
```

3. Откройте браузер и перейдите по адресу: http://localhost:5000

## Данные по умолчанию

При первом запуске создается администратор:
- **Логин**: admin
- **Пароль**: admin123

## Модели данных

### User (Пользователь)
- `id` - идентификатор
- `login` - логин (уникальный)
- `password_hash` - хеш пароля
- `surname` - фамилия
- `name` - имя
- `patronymic` - отчество
- `role_id` - идентификатор роли
- `created_at` - дата создания

### Role (Роль)
- `id` - идентификатор
- `name` - название роли
- `description` - описание роли

### VisitLog (Журнал посещений)
- `id` - идентификатор записи
- `path` - путь до страницы
- `user_id` - идентификатор пользователя (может быть пустым)
- `created_at` - дата посещения

## Система прав доступа

### Декоратор check_rights

```python
@check_rights(['create_users'])
def create_user():
    # Только администраторы могут создавать пользователей
    pass

@check_rights(['edit_own_data'])
def edit_user(user_id):
    # Пользователи могут редактировать только свои данные
    pass
```

### Права доступа

- **create_users** - создание пользователей (только администраторы)
- **edit_own_data** - редактирование своих данных
- **view_own_profile** - просмотр своего профиля
- **view_own_visits** - просмотр журнала посещений
- **delete_users** - удаление пользователей (только администраторы)

## Тестирование

Запустите тесты:
```bash
python test_app.py
```

Тесты покрывают:
- Систему авторизации и прав доступа
- Создание записей в журнале посещений
- Функциональность отчетов
- Экспорт в CSV
- Ограничения доступа для разных ролей

## Технологии

- **Flask** - веб-фреймворк
- **SQLAlchemy** - ORM для работы с БД
- **Bootstrap 5** - CSS фреймворк для стилизации
- **SQLite** - база данных
- **Werkzeug** - для хеширования паролей
- **Flask Blueprint** - модульная архитектура

## Особенности реализации

1. **Автоматическое логирование**: Все посещения страниц записываются автоматически
2. **Модульная архитектура**: Отчеты вынесены в отдельный Blueprint
3. **Гибкая система прав**: Легко добавлять новые права и роли
4. **Безопасность**: Пользователи не могут изменять свои роли
5. **Удобный интерфейс**: Кнопки отображаются согласно правам пользователя
